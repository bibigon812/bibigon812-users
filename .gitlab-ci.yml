---
stages:
  - test_2.4.4
  - test_2.5.1
  - build

before_script:
  - bundle -v
  - rm Gemfile.lock || true
  - gem update --system
  - gem update bundler
  - gem --version
  - bundle -v
  - bundle install --without system_tests

rubocop-2.4.4:
  stage: test_2.4.4
  image: ruby:2.4.4
  script:
    - bundle exec rake rubocop

syntax-2.4.4:
  stage: test_2.4.4
  image: ruby:2.4.4
  script:
    - bundle exec rake syntax lint

metadata-2.4.4:
  stage: test_2.4.4
  image: ruby:2.4.4
  script:
    - bundle exec rake metadata_lint

rspec-puppet-2.4.4:
  stage: test_2.4.4
  image: ruby:2.4.4
  variables:
    PUPPET_GEM_VERSION: ~> 4.0
    CHECK: spec
    LANG: C.UTF-8
  script:
    - bundle update
    - bundle exec rake $CHECK

rubocop-2.5.1:
  stage: test_2.5.1
  image: ruby:2.5.1
  script:
    - bundle exec rake rubocop

syntax-2.5.1:
  stage: test_2.5.1
  image: ruby:2.5.1
  script:
    - bundle exec rake syntax lint

metadata-2.5.1:
  stage: test_2.5.1
  image: ruby:2.5.1
  script:
    - bundle exec rake metadata_lint

rspec-puppet-2.5.1:
  stage: test_2.5.1
  image: ruby:2.5.1
  variables:
    PUPPET_GEM_VERSION: ~> 4.0
    CHECK: spec
    LANG: C.UTF-8
  script:
    - bundle update
    - bundle exec rake $CHECK

package:
  stage: build
  image: ruby:2.4.4
  variables:
    LANG: C.UTF-8
    VERSION: bundle exec rake module:version
  only:
    - tags
  artifacts:
    paths:
      - pkg/spbtv-users-$(eval $VERSION).tar.gz
  script:
    - bundle exec rake module:clean
    - bundle exec rake build
